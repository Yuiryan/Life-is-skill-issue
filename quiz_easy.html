<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shiro – Easy Quiz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700&display=swap">
    <link rel="stylesheet" href="assets/ui.css">
    <script src="assets/ui.js" defer></script>
    <script>
        (function(){
            try{
                const savedTheme = localStorage.getItem('shiroTheme');
                if(savedTheme === 'dark'){
                    document.documentElement.classList.add('theme-dark');
                }
            }catch(err){
                /* ignore */
            }
        })();
    </script>
    <style>
        :root {
            color-scheme: light;
            --bg-color: #f3f4f6;
            --text-color: #111827;
            --nav-bg: #ffffff;
            --nav-border: #e5e7eb;
            --nav-button: #6b7280;
            --nav-button-hover: #111827;
            --card-bg: #ffffff;
            --card-text: #111827;
            --card-shadow: 0 20px 50px rgba(15,23,42,0.12);
            --answer-bg: #f9fafb;
            --answer-border: #e5e7eb;
            --answer-hover-bg: #e5f2ff;
            --answer-hover-border: #93c5fd;
            --subtitle-color: #6b7280;
            --rank-color: #334155;
            --modal-overlay: rgba(15,23,42,0.45);
            --theme-toggle-bg: rgba(15,23,42,0.08);
            --theme-toggle-color: #0f172a;
            --theme-toggle-border: rgba(15,23,42,0.13);
            --image-bg: #f9fafb;
        }

        .theme-dark {
            color-scheme: dark;
            --bg-color: #020617;
            --text-color: #e2e8f0;
            --nav-bg: rgba(2,6,23,0.85);
            --nav-border: #1e293b;
            --nav-button: #cbd5f5;
            --nav-button-hover: #ffffff;
            --card-bg: rgba(15,23,42,0.85);
            --card-text: #e2e8f0;
            --card-shadow: 0 20px 50px rgba(2,6,23,0.65);
            --answer-bg: rgba(148,163,184,0.1);
            --answer-border: rgba(148,163,184,0.25);
            --answer-hover-bg: rgba(59,130,246,0.25);
            --answer-hover-border: rgba(59,130,246,0.6);
            --subtitle-color: #cbd5f5;
            --rank-color: #e2e8f0;
            --modal-overlay: rgba(2,6,23,0.7);
            --theme-toggle-bg: rgba(15,23,42,0.75);
            --theme-toggle-color: #f8fafc;
            --theme-toggle-border: rgba(248,250,252,0.25);
            --image-bg: rgba(15,23,42,0.65);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            transition: background 0.25s ease, color 0.25s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            animation: pageFadeIn 0.4s ease-out;
        }

        @keyframes pageFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* NAVBAR */
        .navbar {
            height: clamp(60px, 9vw, 72px);
            border-bottom: 1px solid var(--nav-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 clamp(16px, 4vw, 48px);
            background: var(--nav-bg);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-left img {
            height: clamp(40px, 8vw, 64px);
            width: clamp(40px, 8vw, 64px);
            object-fit: contain;
        }

        .brand-name {
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: clamp(18px, 2.6vw, 24px);
        }

        .nav-right {
            font-size: 13px;
            color: var(--nav-button);
            cursor: pointer;
        }

        .nav-right:hover { color: var(--nav-button-hover); }

        /* MAIN */
        .main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: clamp(16px, 5vw, 64px);
        }

        .card {
            background: var(--card-bg);
            color: var(--card-text);
            border-radius: 24px;
            padding: clamp(20px, 4vw, 36px);
            max-width: 720px;
            width: min(100%, 720px);
            box-shadow: var(--card-shadow);

            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        @keyframes cardIn {
            from { opacity: 0; transform: scale(0.97); }
            to   { opacity: 1; transform: scale(1); }
        }

        .card.is-transitioning {
            animation: cardIn 0.35s ease-out;
        }

        .question-top-label {
            font-size: 12px;
            color: var(--subtitle-color);
            margin-bottom: 6px;
        }

        .definition {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .question-image-box {
            display: flex;
            justify-content: center;
            margin-bottom: 18px;
        }

    .question-image-box img {
     width: min(320px, 80vw);
     aspect-ratio: 1 / 1;
     object-fit: contain;
     border-radius: 16px;
     background: var(--image-bg);
     }

        .answers-label {
            font-size: 13px;
            margin-bottom: 8px;
            color: var(--subtitle-color);
            text-align: center;
        }

        .answers-row {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .answer-btn {
            flex: 0 0 40%;
            border-radius: 14px;
            border: 1px solid var(--answer-border);
            background: var(--answer-bg);
            color: var(--text-color);
            padding: 14px 16px;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            min-height: 56px;
            transition: background 0.15s ease, border-color 0.15s ease;
            --hover-shadow: 0 14px 28px rgba(15,23,42,0.08);
        }

        .answer-btn:hover {
            background: var(--answer-hover-bg);
            border-color: var(--answer-hover-border);
            transform: translateY(-1px);
        }

        .answer-btn.correct {
            background: #dcfce7;
            border-color: #22c55e;
        }

        .answer-btn.wrong {
            background: #fee2e2;
            border-color: #f97373;
        }

        .answer-btn:disabled {
            cursor: default;
            opacity: 0.95;
        }

        .feedback {
            margin-top: 14px;
            font-size: 14px;
            min-height: 20px;
            text-align: center;
        }

        .feedback.correct { color: #16a34a; }
        .feedback.wrong   { color: #dc2626; }

        .progress {
            margin-top: 4px;
            font-size: 12px;
            color: #6b7280;
            text-align: center;
        }

        .rank-message {
            margin-top: 6px;
            font-size: 14px;
            text-align: center;
            color: var(--rank-color);
            min-height: 20px;
        }

        .restart-btn {
            margin: 18px auto 0;
            border-radius: 999px;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            background: #22c55e;
            color: #ffffff;
            cursor: pointer;
            display: block;
            box-shadow: 0 10px 24px rgba(34,197,94,0.35);
            --hover-shadow: 0 16px 32px rgba(34,197,94,0.45);
        }

        .restart-btn:hover { background: #16a34a; }

        @media (max-width: 600px) {
            .navbar {
                flex-direction: column;
                gap: 8px;
                height: auto;
                padding: 16px;
            }

            .card { padding: 20px 16px 18px; border-radius: 20px; }
            .question-image-box img { width: 150px; height: 150px; }
            .answer-btn { flex: 1 1 100%; }
        }

        body.resume-modal-open {
            overflow: hidden;
        }

        .resume-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            background: var(--modal-overlay);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
            z-index: 1000;
        }

        .resume-overlay.is-open {
            opacity: 1;
            pointer-events: auto;
        }

        .resume-dialog {
            width: min(420px, 90vw);
            background: rgba(255,255,255,0.9);
            border-radius: 24px;
            padding: clamp(20px, 4vw, 32px);
            text-align: center;
            box-shadow: 0 25px 60px rgba(15,23,42,0.25);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
        }

        .resume-title {
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .resume-message {
            font-size: 0.95rem;
            color: #4b5563;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .resume-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .resume-btn {
            border: none;
            border-radius: 999px;
            padding: 12px 20px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .resume-btn:focus {
            outline: 2px solid #2563eb;
            outline-offset: 3px;
        }

        .resume-btn.primary {
            background: #2563eb;
            color: #ffffff;
            box-shadow: 0 12px 30px rgba(37,99,235,0.35);
        }

        .resume-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 16px 32px rgba(37,99,235,0.4);
        }

        .resume-btn.ghost {
            background: rgba(255,255,255,0.85);
            color: #111827;
            border: 1px solid rgba(17,24,39,0.08);
        }

        .resume-btn.ghost:hover {
            background: rgba(249,250,251,0.95);
            transform: translateY(-1px);
        }

        @media (min-width: 480px) {
            .resume-actions {
                flex-direction: row;
            }

            .resume-actions .resume-btn {
                flex: 1;
            }
        }
        .theme-dark .resume-dialog {
            background: rgba(15,23,42,0.9);
            color: #e2e8f0;
        }

        .theme-toggle {
            position: fixed;
            bottom: 18px;
            right: 18px;
            border-radius: 999px;
            border: 1px solid var(--theme-toggle-border);
            background: var(--theme-toggle-bg);
            color: var(--theme-toggle-color);
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            z-index: 1400;
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .theme-toggle:hover {
            transform: translateY(-1px);
        }

        @media (max-width: 640px) {
            .theme-toggle {
                bottom: 16px;
                right: 16px;
            }
        }
    </style>
</head>
<body>
<button type="button" class="theme-toggle" id="theme-toggle">
    <span id="theme-toggle-label">Dark mode</span>
</button>
<header class="navbar">
    <div class="nav-left">
        <img src="assets/logo.png" alt="Shiro logo">
        <div class="brand-name">Shiro – Easy</div>
    </div>
    <button type="button" class="nav-right" id="btn-back-modes">
        Back to modes
    </button>
</header>

<main class="main">
    <div class="card" id="card">
        <div class="question-top-label" id="label-definition">Câu hỏi</div>
        <div class="definition" id="definition-text"></div>

        <div class="question-image-box">
            <img id="question-image" src="assets/q1.png" alt="illustration">
        </div>

        <div class="answers-label" id="label-choose">Hãy chọn đáp án</div>
        <div class="answers-row">
            <button type="button" class="answer-btn" id="ans-0"></button>
            <button type="button" class="answer-btn" id="ans-1"></button>
        </div>

        <div class="feedback" id="feedback"></div>
        <div class="progress" id="progress-text"></div>
        <div class="rank-message" id="rank-message"></div>
    </div>
</main>

<div class="resume-overlay" id="resume-overlay" aria-hidden="true">
    <div class="resume-dialog">
        <div class="resume-title" id="resume-title"></div>
        <p class="resume-message" id="resume-message"></p>
        <div class="resume-actions">
            <button type="button" class="resume-btn primary" id="resume-continue"></button>
            <button type="button" class="resume-btn ghost" id="resume-restart"></button>
        </div>
    </div>
</div>

<script>
    const THEME_STORAGE_KEY = "shiroTheme";
    const themeToggleBtn = document.getElementById("theme-toggle");
    const themeToggleLabel = document.getElementById("theme-toggle-label");

    function applyThemePreference(theme) {
        if (theme === "dark") {
            document.documentElement.classList.add("theme-dark");
        } else {
            document.documentElement.classList.remove("theme-dark");
        }

        if (themeToggleLabel) {
            themeToggleLabel.textContent = theme === "dark" ? "Light mode" : "Dark mode";
        }
    }

    (function initTheme() {
        let storedTheme = null;
        try {
            storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
        } catch (err) {
            storedTheme = null;
        }

        let resolvedTheme = storedTheme;
        if (!resolvedTheme) {
            const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
            resolvedTheme = prefersDark ? "dark" : "light";
        }

        applyThemePreference(resolvedTheme);

        if (!storedTheme) {
            try {
                localStorage.setItem(THEME_STORAGE_KEY, resolvedTheme);
            } catch (err) {
                /* ignore */
            }
        }
    })();

    themeToggleBtn?.addEventListener("click", () => {
        const nextTheme = document.documentElement.classList.contains("theme-dark") ? "light" : "dark";
        applyThemePreference(nextTheme);
        try {
            localStorage.setItem(THEME_STORAGE_KEY, nextTheme);
        } catch (err) {
            /* ignore */
        }
    });

    if (typeof window.matchMedia === "function") {
        const mq = window.matchMedia("(prefers-color-scheme: dark)");
        const listener = (event) => {
            let storedTheme = null;
            try {
                storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
            } catch (err) {
                storedTheme = null;
            }
            if (storedTheme) return;
            applyThemePreference(event.matches ? "dark" : "light");
        };

        if (mq.addEventListener) {
            mq.addEventListener("change", listener);
        } else if (mq.addListener) {
            mq.addListener(listener);
        }
    }

    // 10 câu – mỗi câu có vi/en/jp
    const questions = [
        {
            vi: "Ảnh dưới là AI hay thật?",
            en: "Is the image below generated by AI or not?",
            jp: "下の写真は本物ですか、それともAIですか？",
            img: "assets/1.1.png",
            correct: 0
        },
        {
            vi: "Ảnh dưới là AI hay thật?",
            en: "Is the image below generated by AI or not?",
            jp: "下の写真は本物ですか、それともAIですか？",
            img: "assets/1.2.jpg",
            correct: 0
        },
        {
            vi: "Ảnh dưới là AI hay thật?",
            en: "Is the image below generated by AI or not?",
            jp: "下の写真は本物ですか、それともAIですか？",
            img: "assets/1.3.jpg",
            correct: 0
        },
        {
            vi: "Ảnh dưới là AI hay thật?",
            en: "Is the image below generated by AI or not?",
            jp: "下の写真は本物ですか、それともAIですか？",
            img: "assets/1.4.jpg",
            correct: 1
        },
        {
            vi: "Ảnh dưới là AI hay thật?",
            en: "Is the image below generated by AI or not?",
            jp: "下の写真は本物ですか、それともAIですか？",
            img: "assets/1.5.jpg",
            correct: 1
        },
        {
            vi: "Ảnh dưới là AI hay thật?",
            en: "Is the image below generated by AI or not?",
            jp: "下の写真は本物ですか、それともAIですか？",
            img: "assets/1.6.jpg",
            correct: 1
        },
        {
            vi: "Ảnh dưới là AI hay thật?",
            en: "Is the image below generated by AI or not?",
            jp: "下の写真は本物ですか、それともAIですか？",
            img: "assets/1.7.png",
            correct: 0
        },
        {
            vi: "Ảnh dưới là AI hay thật?",
            en: "Is the image below generated by AI or not?",
            jp: "下の写真は本物ですか、それともAIですか？",
            img: "assets/1.8.png",
            correct: 0
        },
        {
            vi: "Ảnh dưới là AI hay thật?",
            en: "Is the image below generated by AI or not?",
            jp: "下の写真は本物ですか、それともAIですか？",
            img: "assets/1.9.jpg",
            correct: 1
        },
        {
            vi: "Ảnh dưới là AI hay thật?",
            en: "Is the image below generated by AI or not?",
            jp: "下の写真は本物ですか、それともAIですか？",
            img: "assets/1.10.jpg",
            correct: 1
        }
    ];

    // UI đa ngôn ngữ + nhãn Có/Không / Yes/No / はい/いいえ
    const uiTexts = {
        en: {
            defLabel: "Question",
            chooseLabel: "Please choose an answer",
            back: "Back to modes",
            correct: "Correct!",
            wrong: "Incorrect.",
            yes: "AI",
            no: "Not AI",
            progress: (cur, total) => `Question ${cur} of ${total}`,
            finished: (s, t) => `Finished! You got ${s} / ${t} correct.`,
            restart: "Restart",
            resumeTitle: "Pick up where you left off?",
            resumeMessage: (q) => `You stopped at question ${q} before answering. Continue?`,
            resumeContinue: "Continue",
            resumeRestart: "Start over",
            rankings: [
                { max: 4, message: () => "Rookie detector – the AI still tricks you. Review the tells and try again." },
                { max: 8, message: () => "Solid instincts! You're already spotting most of the fakes." },
                { max: 10, message: () => "Unstoppable truth radar. AI images hardly fool you anymore." }
            ]
        },
        vi: {
            defLabel: "Câu hỏi",
            chooseLabel: "Hãy chọn đáp án",
            back: "Về chọn chế độ",
            correct: "Đúng rồi!",
            wrong: "Sai mất rồi...",
            yes: "AI",
            no: "Không phải AI",
            progress: (cur, total) => `Câu ${cur} / ${total}`,
            finished: (s, t) => `Hoàn thành! Bạn đúng ${s} / ${t} câu.`,
            restart: "Làm lại",
            resumeTitle: "Tiếp tục làm tiếp?",
            resumeMessage: (q) => `Lần trước bạn dừng ở câu ${q} (chưa trả lời). Bạn có muốn tiếp tục không?`,
            resumeContinue: "Tiếp tục",
            resumeRestart: "Bắt đầu lại",
            rankings: [
                { max: 4, message: () => "Tân binh chống AI – bạn vẫn bỏ lỡ nhiều dấu hiệu, thử lại nhé!" },
                { max: 8, message: () => "Khá tốt! Bạn đã nhận ra phần lớn chi tiết bất thường." },
                { max: 10, message: () => "Thợ săn AI thứ thiệt, khó có hình giả nào qua mặt bạn." }
            ]
        },
        jp: {
            defLabel: "質問",
            chooseLabel: "答えを選んでください",
            back: "モード選択へ戻る",
            correct: "正解！",
            wrong: "不正解…",
            yes: "AI",
            no: "AIではない",
            progress: (cur, total) => `${total}問中 ${cur}問目`,
            finished: (s, tot) => `お疲れさま！ ${tot}問中${s}問正解しました。`,
            restart: "もう一度",
            resumeTitle: "再開しますか？",
            resumeMessage: (q) => `前回は第${q}問で中断しました（未回答）。続けますか？`,
            resumeContinue: "続ける",
            resumeRestart: "最初から",
            rankings: [
                { max: 4, message: () => "ビギナー判別士。まだAIにだまされがちなので、もう一度挑戦しましょう。" },
                { max: 8, message: () => "かなり良い感覚です！多くの違和感を見抜けています。" },
                { max: 10, message: () => "AIキラー級。偽画像をほぼ完全に見抜けます。" }
            ]
        }
    };

    const btnBack         = document.getElementById("btn-back-modes");
    const labelDefinition = document.getElementById("label-definition");
    const labelChoose     = document.getElementById("label-choose");
    const definitionText  = document.getElementById("definition-text");
    const feedbackEl      = document.getElementById("feedback");
    const progressText    = document.getElementById("progress-text");
    const rankMessageEl   = document.getElementById("rank-message");
    const imageEl         = document.getElementById("question-image");
    const cardEl          = document.getElementById("card");

    const answerButtons = [
        document.getElementById("ans-0"),
        document.getElementById("ans-1")
    ];

    const resumeOverlay     = document.getElementById("resume-overlay");
    const resumeTitleEl     = document.getElementById("resume-title");
    const resumeMessageEl   = document.getElementById("resume-message");
    const resumeContinueBtn = document.getElementById("resume-continue");
    const resumeRestartBtn  = document.getElementById("resume-restart");

    const savedLang = localStorage.getItem("shiroLang") || "en";

    let current = 0;
    let score   = 0;
    let locked  = false;
    let currentLang = "en";
    let t       = uiTexts.en;
    let pendingResumeState = null;
    const NEXT_QUESTION_DELAY = 500;

    function playCardTransition() {
        if (!cardEl) return;
        cardEl.classList.add("is-transitioning");
    }

    if (cardEl) {
        cardEl.addEventListener("animationend", () => {
            cardEl.classList.remove("is-transitioning");
        });
    }

    function updateResumeCopy(questionNumberOverride) {
        const candidate = typeof questionNumberOverride === "number"
            ? questionNumberOverride
            : Math.min(current + 1, questions.length);

        resumeTitleEl.textContent = t.resumeTitle;
        resumeMessageEl.textContent = t.resumeMessage(candidate);
        resumeContinueBtn.textContent = t.resumeContinue;
        resumeRestartBtn.textContent = t.resumeRestart;
    }

    function applyLang(lang) {
        currentLang = lang;
        t = uiTexts[lang] || uiTexts.en;

        labelDefinition.textContent = t.defLabel;
        labelChoose.textContent     = t.chooseLabel;
        btnBack.textContent         = t.back;

        const resumeNumber = pendingResumeState
            ? Math.min(sanitizeIndex(pendingResumeState.current) + 1, questions.length)
            : undefined;
        updateResumeCopy(resumeNumber);
        renderQuestion();
    }

    function renderQuestion() {
        const q = questions[current];

        playCardTransition();

        const qText = q[currentLang] || q.vi;
        definitionText.textContent = qText;

        imageEl.src = q.img;
        imageEl.style.visibility = "visible";

        feedbackEl.textContent = "";
        feedbackEl.className   = "feedback";
        if (rankMessageEl) {
            rankMessageEl.textContent = "";
            rankMessageEl.style.display = "none";
        }

        // nhãn Yes/No theo ngôn ngữ
        answerButtons[0].textContent = t.yes;
        answerButtons[1].textContent = t.no;

        answerButtons.forEach(btn => {
            btn.classList.remove("correct", "wrong");
            btn.disabled = false;
            btn.style.display = "";
        });

        progressText.textContent = t.progress(current + 1, questions.length);
        locked = false;
    }

    function getRankMessage(scoreValue) {
        const tiers = Array.isArray(t.rankings) ? t.rankings : [];
        const tier = tiers.find(entry => scoreValue <= entry.max);
        if (!tier) return "";
        return typeof tier.message === "function"
            ? tier.message(scoreValue, questions.length)
            : tier.message;
    }

    function showResult() {
        clearState();
        definitionText.textContent = "";
        imageEl.style.visibility   = "hidden";
        labelChoose.textContent    = "";
        feedbackEl.textContent     = t.finished(score, questions.length);
        feedbackEl.className       = "feedback correct";
        progressText.textContent   = "";
        if (rankMessageEl) {
            const rankText = getRankMessage(score);
            rankMessageEl.textContent = rankText;
            rankMessageEl.style.display = rankText ? "block" : "none";
        }

        answerButtons.forEach(btn => btn.style.display = "none");

        // create action buttons: Restart + Back to modes (clears saved state)
        const actionsWrap = document.createElement("div");
        actionsWrap.style.display = "flex";
        actionsWrap.style.gap = "10px";
        actionsWrap.style.marginTop = "12px";

        const restartBtn = document.createElement("button");
        restartBtn.className = "restart-btn";
        restartBtn.type = "button";
        restartBtn.textContent = t.restart;
        restartBtn.addEventListener("click", () => location.reload());

        const backToModesBtn = document.createElement("button");
        backToModesBtn.className = "restart-btn";
        backToModesBtn.type = "button";
        backToModesBtn.textContent = t.back || "Back to modes";
        backToModesBtn.addEventListener("click", () => {
            clearState();
            window.location.href = "quiz_home.html";
        });

        actionsWrap.appendChild(restartBtn);
        actionsWrap.appendChild(backToModesBtn);
        cardEl.appendChild(actionsWrap);
    }

    function handleAnswer(index) {
        if (locked) return;
        locked = true;

        const q = questions[current];
        const nextIndex = current + 1;
        const willFinish = nextIndex >= questions.length;

        answerButtons.forEach(btn => btn.disabled = true);

        if (index === q.correct) {
            feedbackEl.textContent = t.correct;
            feedbackEl.className   = "feedback correct";
            answerButtons[index].classList.add("correct");
            score++;
        } else {
            feedbackEl.textContent = t.wrong;
            feedbackEl.className   = "feedback wrong";
            answerButtons[index].classList.add("wrong");
            answerButtons[q.correct].classList.add("correct");
        }

        current = nextIndex;
        persistState();

        setTimeout(() => {
            if (!willFinish) {
                renderQuestion();
            } else {
                showResult();
            }
        }, NEXT_QUESTION_DELAY);
    }

    answerButtons.forEach((btn, idx) => {
        btn.addEventListener("click", () => handleAnswer(idx));
    });

    const STORAGE_KEY = "shiroQuiz_easy";

    function shouldPersistProgress(index = current) {
        return Number.isFinite(index) && index > 0 && index < questions.length;
    }

    function persistState() {
        if (!shouldPersistProgress()) {
            clearState();
            return;
        }

        try {
            const payload = {
                current,
                score,
                currentLang
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        } catch (err) {
            /* ignore storage errors */
        }
    }

    function readState() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            return raw ? JSON.parse(raw) : null;
        } catch (err) {
            return null;
        }
    }

    function clearState() {
        try {
            localStorage.removeItem(STORAGE_KEY);
        } catch (err) {
            /* ignore */
        }
    }

    function sanitizeIndex(value) {
        const num = Number(value);
        if (!Number.isFinite(num)) return 0;
        return Math.min(Math.max(Math.floor(num), 0), questions.length - 1);
    }

    function sanitizeScore(value) {
        const num = Number(value);
        if (!Number.isFinite(num) || num < 0) return 0;
        return Math.min(Math.floor(num), questions.length);
    }

    function hasResumeProgress(state) {
        if (!state) return false;
        const idx = Number(state.current);
        return Number.isFinite(idx) && idx > 0 && idx < questions.length;
    }

    function openResumePrompt(state) {
        pendingResumeState = state;
        const qNumber = Math.min(sanitizeIndex(state.current) + 1, questions.length);
        updateResumeCopy(qNumber);

        resumeOverlay.classList.add("is-open");
        resumeOverlay.setAttribute("aria-hidden", "false");
        document.body.classList.add("resume-modal-open");

        requestAnimationFrame(() => {
            resumeContinueBtn.focus({ preventScroll: true });
        });
    }

    function closeResumePrompt() {
        resumeOverlay.classList.remove("is-open");
        resumeOverlay.setAttribute("aria-hidden", "true");
        document.body.classList.remove("resume-modal-open");
    }

    resumeContinueBtn.addEventListener("click", () => {
        if (!pendingResumeState) {
            closeResumePrompt();
            return;
        }

        const targetIndex = sanitizeIndex(pendingResumeState.current);
        current = targetIndex;
        score = sanitizeScore(pendingResumeState.score);
        const langToApply = pendingResumeState.currentLang || savedLang;

        pendingResumeState = null;
        applyLang(langToApply);
        closeResumePrompt();
        persistState();
    });

    resumeRestartBtn.addEventListener("click", () => {
        pendingResumeState = null;
        current = 0;
        score = 0;
        clearState();
        renderQuestion();
        closeResumePrompt();
    });

    btnBack.addEventListener("click", () => {
        persistState();
        window.location.href = "quiz_home.html";
    });

    window.addEventListener("beforeunload", () => {
        persistState();
    });

    const savedState = readState();
    applyLang(savedLang);

    if (hasResumeProgress(savedState)) {
        openResumePrompt(savedState);
    } else if (savedState) {
        clearState();
    }
</script>
</body>
</html>
